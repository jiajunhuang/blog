# CGOç®€æ˜æ•™ç¨‹

## Hello World

```go
package main

// #include <stdlib.h>
import "C"

import (
	"fmt"
)

func main() {
    fmt.Println(int(C.random()))
}
```

å½“ç„¶è¿™å¹¶ä¸æ˜¯Hello Worldã€‚æˆ‘ä»¬ä¸é¦–å…ˆè¾“å‡ºHello Worldæ˜¯æœ‰åŸå› çš„ï¼Œæ¥ä¸‹æ¥å°±ä¼šè®²åˆ°ã€‚ä¸è¿‡é¦–å…ˆæˆ‘ä»¬åˆ†æä¸€ä¸‹ç°åœ¨è¿™ä¸ªç¨‹åºã€‚
é¦–å…ˆä»ç»“æ„ä¸Šæ¥çœ‹å¯ä»¥çŸ¥é“è¿™å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„Goç¨‹åºï¼Œç¬¬ä¸€è¡Œ `package main` å£°æ˜è¿™ä¸ªä»£ç æ˜¯åœ¨mainåŒ…é‡Œã€‚ç„¶åä¸‹é¢æœ‰ `func main`
æ˜¯ç¨‹åºçš„å…¥å£ã€‚

```
// #inlcude <stdlib.h>
import "C"

```

è¿™ä¸‰è¡Œæ˜¯Goè°ƒCæ‰è¿™æ ·çš„ï¼Œ`import "C"` æ˜¯ä¸ºäº†å¯ä»¥åœ¨Goç¨‹åºé‡Œç›´æ¥ä½¿ç”¨Cé‡Œçš„ä¸€äº›å‡½æ•°ï¼Œä¾‹å¦‚mainä¸­ `C.random()`ï¼Œè€Œ `import "C"`
ä¸Šè¾¹çš„æ³¨é‡Šå«åšpreambleï¼Œæ³¨æ„å¿…é¡»å’Œ `import "C"`ç´§ç´§æŒ¨ç€ä¸­é—´ä¸èƒ½æœ‰ç©ºæ ¼ã€‚æ³¨é‡Šçš„é£æ ¼å¯ä»¥æ˜¯ `// #include...` ä¹Ÿå¯ä»¥æ˜¯ `/*#include ...*/`
è¿™æ ·çš„ã€‚æ­¤å¤–å¯ä»¥åœ¨ preamble ä¸­åŠ å…¥ `// #cgo ` å¼€å¤´çš„æ³¨é‡Šï¼Œç”¨äºæŒ‡ç¤ºç¼–è¯‘å’Œé“¾æ¥ä¸­å‘ç”Ÿçš„ä¸€äº›äº‹æƒ…ï¼Œä¾‹å¦‚é“¾æ¥å“ªä¸ªåŠ¨æ€é“¾æ¥åº“ç­‰ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹Hello Worldã€‚

é¦–å…ˆæˆ‘ä»¬éœ€è¦ä¸‰ä¸ªæ–‡ä»¶ï¼Œ`helloworld.h`:

```c
#ifndef __helloworld
#define __helloworld

void Printf(char *s);

#endif
```

`helloworld.c`:

```c
#include <stdio.h>

void Printf(char *s) {
    printf("%s", s);
}
```

`main.go`:

```go
package main

// #include "helloworld.h"
import "C"

func main() {
    C.Printf("hello world")
}
```

ä¸ºå•¥ä¸ç›´æ¥ `C.printf` è¾“å‡ºå‘¢ï¼Œå› ä¸ºåœ¨wikiä¸­æåˆ°cgoç›®å‰æš‚æ—¶è¿˜ä¸æ”¯æŒå˜é•¿å‚æ•°çš„Cå‡½æ•°ï¼Œæ‰€ä»¥è¦æˆ‘ä»¬è‡ªå·±åŒ…è£…ä¸€ä¸‹ã€‚ç¼–è¯‘ï¼š

```bash
$ go build
./main.go:7: cannot use "hello world" (type string) as type *_Ctype_char in argument to _Cfunc_Printf
```

åŸå› æ˜¯Cå’ŒGoçš„å­—ç¬¦ä¸²ä¸æ˜¯é€šç”¨çš„ï¼Œæˆ‘ä»¬è¦æŠŠGoçš„å­—ç¬¦ä¸²è½¬æˆCçš„å­—ç¬¦ä¸²ï¼Œä½†æ˜¯å› ä¸ºä¸æ˜¯åœ¨ç¼–è¯‘çš„è¿™ä¸ªè¿‡ç¨‹ç”³è¯·å†…å­˜ï¼Œè€Œæ˜¯åœ¨å †é‡Œ
ç”³è¯·å†…å­˜å­˜å‚¨å­—ç¬¦ä¸²ï¼Œè€ŒGoçš„åƒåœ¾å›æ”¶æ˜¯ç®¡ä¸åˆ°Cç”³è¯·çš„å†…å­˜ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è‡ªè¡Œé”€æ¯å¯¹åº”çš„å†…å­˜ã€‚

```go
package main

// #include <stdlib.h>
// #include "helloworld.h"
import "C"

import (
    "unsafe"
)

func main() {
    cs := C.CString("hello world\n")
    defer C.free(unsafe.Pointer(cs))

    C.Printf(cs)
}
```

ä¹Ÿå¯ä»¥æˆ‘ä»¬å…ˆæŠŠCç¼–è¯‘æˆåŠ¨æ€é“¾æ¥åº“ï¼Œç„¶ååœ¨Goé‡ŒæŒ‡ç¤ºé“¾æ¥ï¼š

```go
package main

// #cgo LDFLAGS: -L${SRCDIR}/ -Wl,-rpath,${SRCDIR}/ -lhelloworld
// #include <stdlib.h>
// #include "helloworld.h"
import "C"

import (
    "unsafe"
)

func main() {
    cs := C.CString("hello world\n")
    defer C.free(unsafe.Pointer(cs))

    C.Printf(cs)
}
```

æˆ‘ä»¬å…ˆæŠŠ `helloworld.c` ç¼–è¯‘æˆåŠ¨æ€é“¾æ¥åº“ `libhelloworld.so`ã€‚

## ç±»å‹

Cå’ŒGoä¸­æœ‰å¾ˆå¤šç±»å‹æ˜¯å¯¹åº”çš„ï¼Œä½†æ˜¯éœ€è¦æˆ‘ä»¬è‡ªè¡Œè½¬æ¢ç±»å‹ã€‚ä¾‹å¦‚ï¼š

    - C.int
    - C.long
    - C.ulong

å¦‚æœæ˜¯è®¿é—®structå¾—è¿™ä¹ˆç”¨ `C.struct_<structçš„åå­—>`ï¼Œenum,unionå’Œsizeofä¹Ÿç±»ä¼¼ã€‚

å…·ä½“å‚è€ƒï¼šhttps://golang.org/cmd/cgo/#hdr-Go_references_to_C

æ­¤å¤–ï¼Œå¯¹äºæŒ‡é’ˆç±»å‹ï¼Œåˆ™æ˜¯è¯¥å’‹ç”¨å’‹ç”¨ï¼Œæ¯”å¦‚ `*C.int`ã€‚ä½†æ˜¯å¯¹äº `void *`ï¼Œåˆ™éœ€è¦ç”¨ `unsafe.Pointer`æ¥è¡¨ç¤ºã€‚

## å…¶ä»–çŸ¥è¯†

å¦‚æœè¯´éœ€è¦ä»€ä¹ˆå…¶ä»–çŸ¥è¯†ï¼Œé‚£å°±æ˜¯ç¼–è¯‘é“¾æ¥ç›¸å…³çš„çŸ¥è¯†äº†ï¼Œæ¨èã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»-é“¾æ¥ã€è£…è½½ä¸åº“ã€‹ã€‚è¿™æœ¬ä¹¦éå¸¸çš„å¥½ï¼Œå›½äº§ç¥ä¹¦ï¼Œ
ä¸è¿‡è¯´å®è¯ï¼Œå› ä¸ºä¸ç»å¸¸æ¥è§¦ï¼Œçœ‹è¿‡ç„¶ååˆå¿˜è®°äº†å¤§éƒ¨åˆ†å†…å®¹ğŸ¤¦â€â™‚ï¸

## CGOæ˜¯å¦‚ä½•è¿è¡Œçš„

åœ¨Goä¸­è°ƒç”¨Cå‡½æ•°ï¼Œcgoç”Ÿæˆçš„ä»£ç è°ƒç”¨ `runtime.cgocall(_cgo_Cfunc_f, frame)`ï¼Œ`_cgo_Cfunc_f` å°±æ˜¯GCCç¼–è¯‘
å‡ºæ¥çš„ä»£ç ã€‚ `runtime.cgocall` ä¼šè°ƒç”¨ `runtime.asmcgocall(_cgo_Cfunc_f, frame)`ã€‚

`runtime.asmcgocall` ä¼šåˆ‡æ¢åˆ°`m->go` çš„æ ˆç„¶åæ‰§è¡Œä»£ç ï¼Œå› ä¸º `g0` çš„æ ˆæ˜¯æ“ä½œç³»ç»Ÿåˆ†é…çš„æ ˆ(å¤§å°ä¸º8k)ï¼Œè¶³å¤Ÿ
æ‰§è¡ŒCä»£ç ã€‚ `_cgo_Cfunc_f` åœ¨frameä¸­æ‰§è¡ŒCå‡½æ•°ï¼Œç„¶åè¿”å›åˆ° `runtime.asmcgocall`ã€‚ä¹‹åå†åˆ‡å›è°ƒç”¨å®ƒçš„
Gçš„æ ˆã€‚

------------

- https://github.com/golang/go/wiki/cgo
- https://golang.org/cmd/cgo/
- https://blog.golang.org/c-go-cgo
- https://book.douban.com/subject/3652388/
- https://golang.org/src/runtime/cgocall.go
